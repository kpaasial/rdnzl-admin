#!/bin/sh

# Script for updating the host using the build(7) results
# from a buildjail.

# Two modes of operation.

# First mode runs the 'make installkernel' part of the update
# procedure. Also records the installed kernel version with 
# ZFS user properties on the root filesystem.

# TODO: Remove debug prints. Add proper notices where appropriate. 

# TODO: Explore the usefulness of recording of sha256 hash of the
# installed kernel into the ZFS user properties. A mismatch would mean
# that 'make installkernel' has been run and /boot/kernel/kernel has changed. 

# TODO: Guarantee atomicity of the operation. Either both the kernel
# gets installed successfully and the ZFS property operations are
# finished or the operations get rolled back to the initial state 
# in case of any error. 


# Second mode is run after update of world to record the installed
# world version using another set of ZFS user properties
# on the root filesystem.



# The mode can be autodetected by looking at the ZFS user
# properties on the ZFS root filesystem. If the recorded 
# ${SVNREVISION} of the kernel is less than what is on the
# sources it can be deduced that this script hasn't been
# yet run in the first mode to install the new kernel.
#
# Otherwise the second mode should be used.

# Include common functions and settings

PREFIX="@@PREFIX@@"
SHARE_RDNZL="${PREFIX}/share/rdnzl"

. "${SHARE_RDNZL}/rdnzl-zfs-functions.sh"
. "${SHARE_RDNZL}/rdnzl-svn-functions.sh"
. "${PREFIX}/etc/rdnzl-admin/sysupdate-setup.rc"


usage()
{
    echo "Usage: $0 [-h] [-B buildjail] " 
    exit 0
}

# Defaults for settings
# TODO: This could be autodetected at least from kern.osreldate
# and uname -m/uname -p. Other options include looking at
# SVNBRANCH of the root filesystem if set.
: ${BUILDJAIL:="buildstable10amd64"}


# Parse command line arguments to override the defaults.

while getopts "B:h" o
do
    case "$o" in
    B)  BUILDJAIL="$OPTARG";;
    h)  usage;;
    *)  usage;;
    esac

done

shift $((OPTIND-1))

# Read the SVN revision from the buildjail

#BUILDJAILSRC_FS="${JAIL_BASEFS}/${BUILDJAIL}/src"
BUILDJAILOBJ_FS="${JAIL_BASEFS}/${BUILDJAIL}/obj"


#if ! rdnzl_zfs_filesystem_exists "${BUILDJAILSRC_FS}"; then
#    echo "No such buildjail src filesystem ${BUILDJAILSRC_FS}"
#    exit 1
#fi

if ! rdnzl_zfs_filesystem_exists "${BUILDJAILOBJ_FS}"; then
    echo "No such buildjail obj filesystem ${BUILDJAILOBJ_FS}"
    exit 1
fi



#SRC_SVNREVISION=$(rdnzl_zfs_get_property_value "${BUILDJAILSRC_FS}" "${SVNREVISIONPROP}") || \
#    { echo "Can not read SVNREVISION from filesystem ${BUILDJAILSRC_FS}"; exit 1;}

#SRC_SVNBRANCH=$(rdnzl_zfs_get_property_value "${BUILDJAILSRC_FS}" "${SVNBRANCHPROP}") || \
#    { echo "Can not read SVNBRANCH from filesystem ${BUILDJAILSRC_FS}"; exit 1;}


OBJ_SVNREVISION=$(rdnzl_zfs_get_property_value "${BUILDJAILOBJ_FS}" "${SVNREVISIONPROP}") || \
    { echo "Can not read SVNREVISION from filesystem ${BUILDJAILOBJ_FS}"; exit 1;}

OBJ_SVNBRANCH=$(rdnzl_zfs_get_property_value "${BUILDJAILOBJ_FS}" "${SVNBRANCHPROP}") || \
    { echo "Can not read SVNBRANCH from filesystem ${BUILDJAILOBJ_FS}"; exit 1;}


ROOT_DATASET=$(rdnzl_zfs_filesystem_from_path "/")

echo "ROOT_DATASET: ${ROOT_DATASET}"


# Read the SVN revisions of installed kernel and world. If the ZFS user properties
# are not present the revision should be interpreted as 0 (TODO). 

KERNEL_SVNREVISION=$(rdnzl_zfs_get_property_value "${ROOT_DATASET}" "${KERNELSVNREVISIONPROP}")
KERNEL_SVNBRANCH=$(rdnzl_zfs_get_property_value "${ROOT_DATASET}" "${KERNELSVNBRANCHPROP}")
WORLD_SVNREVISION=$(rdnzl_zfs_get_property_value "${ROOT_DATASET}" "${SVNREVISIONPROP}")
WORLD_SVNBRANCH=$(rdnzl_zfs_get_property_value "${ROOT_DATASET}" "${SVNBRANCHPROP}")

echo "KERNEL_SVNREVISION: ${KERNEL_SVNREVISION}"
echo "KERNEL_SVNBRANCH: ${KERNEL_SVNBRANCH}"
echo "WORLD_SVNREVISION: ${WORLD_SVNREVISION}"
echo "WORLD_SVNBRANCH: ${WORLD_SVNBRANCH}"
echo "OBJ_SVNREVISION: ${OBJ_SVNREVISION}"
echo "OBJ_SVNBRANCH: ${OBJ_SVNBRANCH}"

# Compare the SVN revisions of the buildjail /usr/obj and installed kernel.
# If the installed kernel revision is less than the revision of the
# buildjail /usr/obj perform 'make installkernel', record the new revision in
# ZFS user properties and exit. Instruct the user to shutdown and reboot
# to single user mode to continue the host update with the update of 
# world.

if test "${KERNEL_SVNREVISION}" -lt "${OBJ_SVNREVISION}"; then
    echo "Going to perform 'make installkernel' in /usr/src to install the new kernel."

    # Mount /usr/src and /usr/obj if needed
    # TODO: Don't rely on /etc/fstab, use paths to the buildjail filesystems
    # and mount_nullfs directly
    if ! /sbin/mount | grep -q 'on /usr/src'; then
        /sbin/mount /usr/src
    fi   

    if ! /sbin/mount | grep -q 'on /usr/obj'; then
        /sbin/mount /usr/obj
    fi   

    # TODO: Find a way to revert /boot/kernel* to initial state
    # if 'make installkernel' fails midway.

    # Run 'make installkernel'
    /usr/bin/make -C /usr/src installkernel || \
        { echo "'make installkernel' failed"; exit 1; }

    # Record the revision of the newly installed kernel to ZFS user property.
    "${ZFS_CMD}" set "${KERNELSVNREVISIONPROP}=${OBJ_SVNREVISION}" "${ROOT_DATASET}"

    # Branch as well in case it got changed
    "${ZFS_CMD}" set "${KERNELSVNBRANCHPROP}=${OBJ_SVNBRANCH}" "${ROOT_DATASET}"

    # Acknowledge that the kernel got installed
    echo "Installed kernel from build that was done with sources of"
    echo "branch ${OBJ_SVNBRANCH} and SVN revision ${OBJ_SVNREVISION}."
    echo "Restart to single user mode to continue update."

    exit 0
fi 


# If the version of the installed kernel matches the objects we are
# probably in single user mode being run after /upgrade.sh.
# (This won't be run before /upgrade.sh because this script may not
# be available until /upgrade.sh has mounted all filesystems).
# Record the svnrevision of the objects used as the version of the installed
# world on the root filesystem.
# TODO: Find a way to verify that the world was in fact updated to 
# SVNVERSION of the sources before this script is run.

# TODO: Incorporate upgrade2.sh in this script so that it won't be needed
# on ZFS on root systems. This would mean /upgrade.sh would call
# update-host.sh to install world and do the other steps of the update.

# Record the revision of the newly installed world to ZFS user property.
"${ZFS_CMD}" set "${SVNREVISIONPROP}=${OBJ_SVNREVISION}" "${ROOT_DATASET}"
# And branch
"${ZFS_CMD}" set "${SVNBRANCHPROP}=${OBJ_SVNBRANCH}" "${ROOT_DATASET}"

echo "Recorded installed world as branch ${OBJ_SVNBRANCH} and SVN revision ${OBJ_SVNREVISION}"

exit 0
