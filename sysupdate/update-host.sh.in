#!/bin/sh

# Script for updating the host using the build(7) results
# from a buildjail.

# Two modes of operation.

# First mode runs the 'make installkernel' part of the update
# procedure. Also records the installed kernel version with 
# ZFS user properties on the root filesystem.

# TODO: Explore the usefulness of recording of sha256 hash of the
# installed kernel into the ZFS user properties. A mismatch would mean
# that 'make installkernel' has been run and /boot/kernel/kernel has changed. 

# TODO: Guarantee atomicity of the operation. Either both the kernel
# gets installed successfully and the ZFS property operations are
# finished or the operations get rolled back to the initial state 
# in case of any error. 


# Second mode is run after update of world to record the installed
# world version using another set of ZFS user properties
# on the root filesystem.



# The mode can be autodetected by looking at the ZFS user
# properties on the ZFS root filesystem. If the recorded 
# ${SVNREVISION} of the kernel is less than what is on the
# sources it can be deduced that this script hasn't been
# yet run in the first mode to install the new kernel.
#
# Otherwise the second mode should be used.

# Include common functions and settings

usage()
{
    echo "Usage: $0 [-h] [-B buildjail] [-b branch] [-v version]" 
    exit 0
}

PREFIX="@@PREFIX@@"
SHARE_RDNZL="${PREFIX}/share/rdnzl"

. "${SHARE_RDNZL}/rdnzl-zfs-functions.sh"
. "${SHARE_RDNZL}/rdnzl-svn-functions.sh"
. "${PREFIX}/etc/rdnzl-admin/sysupdate-setup.rc"


# Defaults for settings

: ${BRANCH:="stable"}

: ${BRANCHVERSION:="10"}

: ${BUILDJAIL:="buildstable10amd64"}


# Parse command line arguments to override the defaults.

while getopts "B:b:fhv:" o
do
    case "$o" in
    B)  BUILDJAIL="$OPTARG";;
    b)  BRANCH="$OPTARG";;
    f)  FORCE_MODE=1;;
    h)  usage;;
    v)  BRANCHVERSION="$OPTARG";;
    *)  usage;;
    esac

done

shift $((OPTIND-1))

# Read the SVN revision of the sources

SRC_FS="${SRC_BASEFS}/${BRANCH}/${BRANCHVERSION}"

SRC_PATH=$(rdnzl_zfs_get_property_value "${SRC_FS}" mountpoint) || \
    { echo "No sources exist for ${BRANCH}/${BRANCHVERSION}"; exit 1;}

# SVN revision of the source tree
SVNREVISION=$(rdnzl_svn_get_revision "${SRC_PATH}") || \
    { echo "Can't get SVN revision for ${SRC_PATH}"; exit 1;}

BRANCHOFSOURCES=$(rdnzl_svn_get_branch "${SRC_PATH}") || \
    { echo "Can't get SVN branch for ${SRC_PATH}"; exit 1;}


# TODO: Record the SVN revision of the finished build into
# ${BUILDJAILFS}/obj. Use the recorded revision to detect if
# the objects have already been used with 'make installkernel'
# and 'make installworld'


# TODO: This could actually use the bootfs property of
# of the pool
ROOT_DATASET=$(rdnzl_zfs_filesystem_from_path "/")

echo "ROOT_DATASET: ${ROOT_DATASET}"


# Read the SVN revision of the installed kernel. If the ZFS user properties
# are not present the revision should be interpreted as 0 (TODO). 

INSTALLED_KERNEL_REVISION=$(rdnzl_zfs_get_property_value "${ROOT_DATASET}" "${KERNELREVPROP}")
INSTALLED_KERNEL_BRANCH=$(rdnzl_zfs_get_property_value "${ROOT_DATASET}" "${KERNELBRANCHPROP}")
INSTALLED_WORLD_REVISION=$(rdnzl_zfs_get_property_value "${ROOT_DATASET}" "${WORLDREVPROP}")
INSTALLED_WORLD_BRANCH=$(rdnzl_zfs_get_property_value "${ROOT_DATASET}" "${WORLDBRANCHPROP}")

echo "INSTALLED_KERNEL_REVISION: ${INSTALLED_KERNEL_REVISION}"
echo "INSTALLED_KERNEL_BRANCH: ${INSTALLED_KERNEL_BRANCH}"
echo "INSTALLED_WORLD_REVISION: ${INSTALLED_WORLD_REVISION}"
echo "INSTALLED_WORLD_BRANCH: ${INSTALLED_WORLD_BRANCH}"
echo "SVNREVISION: ${SVNREVISION}"
echo "BRANCHOFSOURCES: ${BRANCHOFSOURCES}"


# Compare the SVN revisions of the sources and installed kernel.
# If the installed kernel revision is less than the revision of the
# sources perform 'make installkernel', record the new revision in
# ZFS user properties and exit. Instruct the user to shutdown and reboot
# to single user mode to continue the host update with the update of 
# world.

# TODO: Switching from one branch to another should be possible too
if test "${INSTALLED_KERNEL_REVISION}" -lt "${SVNREVISION}"; then
    echo "Going to perform 'make installkernel' in /usr/src to install the new kernel."

    # Mount /usr/src and /usr/obj if needed
    if ! /sbin/mount | grep -q 'on /usr/src'; then
        /sbin/mount /usr/src
    fi   

    if ! /sbin/mount | grep -q 'on /usr/obj'; then
        /sbin/mount /usr/obj
    fi   

    # TODO: Find a way to revert /boot/kernel* to initial state
    # if 'make installkernel' fails midway.

    # Run 'make installkernel'
    /usr/bin/make -C /usr/src installkernel || \
        { echo "Installkernel failed"; exit 1; }

    # Record the revision of the newly installed kernel to ZFS user property.
    "${ZFS_CMD}" set "${KERNELREVPROP}=${SVNREVISION}" "${ROOT_DATASET}"

    # Branch as well in case it got changed
    "${ZFS_CMD}" set "${KERNELBRANCHPROP}=${BRANCHOFSOURCES}" "${ROOT_DATASET}"

    # Acknowledge that the kernel got installed
    echo "Installed kernel from build that was done with sources of"
    echo "branch ${BRANCH}/${BRANCHVERSION} and SVN revision ${SVNREVISION}."
    echo "Restart to single user mode to continue update."

    exit 0
fi 


# If the version of the installed kernel matches the sources we are
# probably in single user mode being run after /upgrade.sh.
# (This won't be run before /upgrade.sh because this script may not
# be available until /upgrade.sh has mounted all filesystems).
# Record the svnrevision of the sources used as the version of the installed
# world on the root filesystem.
# TODO: Find a way to verify that the world was in fact updated to 
# SVNVERSION of the sources before this script is run.

# Record the revision of the newly installed world to ZFS user property.
"${ZFS_CMD}" set "${WORLDREVPROP}=${SVNREVISION}" "${ROOT_DATASET}"
# And branch
"${ZFS_CMD}" set "${WORLDBRANCHPROP}=${BRANCHOFSOURCES}" "${ROOT_DATASET}"

echo "Recorded installed world as branch ${BRANCHOFSOURCES} and SVN revision ${SVNREVISION}"

exit 0
