#!/bin/sh


# This script does the buildworld/buildkernel part of the update process.
# Prerequisites are that the buildjail exists and a new set of sources
# has been set up by setup-buildjail.sh in buildjail /usr/src and
# a new clean /usr/obj filesystem also exists in the buildjail.

PREFIX="@@PREFIX@@"


SHARE_RDNZL="${PREFIX}/share/rdnzl"

. "${SHARE_RDNZL}/rdnzl-zfs-functions.sh"
. "${SHARE_RDNZL}/rdnzl-jail-functions.sh"
. "${PREFIX}/etc/rdnzl-admin/sysupdate-setup.rc"


usage()
{
    echo "$0 [-B buildjail]" 
    exit 0
}

# Defaults for settings

: ${BUILDJAIL:="buildstable10amd64"}


# Parse command line arguments to override the defaults.

while getopts "B:h" o
do
    case "$o" in
    B)  BUILDJAIL="$OPTARG";;
    h)  usage;;
    *)  usage;;
    esac
done

shift $((OPTIND-1))


# Build jail filesystem
BUILDJAIL_FS="${JAIL_BASEFS}/${BUILDJAIL}"

BUILDJAILSRC_FS="${BUILDJAIL_FS}/src"

BUILDJAILOBJ_FS="${BUILDJAIL_FS}/obj"

# Sanity checks
if ! rdnzl_zfs_filesystem_exists "${BUILDJAIL_FS}"; then
    echo "No such buildjail filesystem ${BUILDJAIL_FS}"
    exit 1
fi

if ! rdnzl_zfs_filesystem_exists "${BUILDJAILSRC_FS}"; then
    echo "No such buildjail src filesystem ${BUILDJAILSRC_FS}"
    exit 1
fi

if ! rdnzl_zfs_filesystem_exists "${BUILDJAILOBJ_FS}"; then
    echo "No such buildjail obj filesystem ${BUILDJAILOBJ_FS}"
    exit 1
fi



# Extract the src and obj branches and revisions
SRC_SVNREVISION=$(rdnzl_zfs_get_property_value "${BUILDJAILSRC_FS}" "${SVNREVISIONPROP}") || \
    { echo "Can not read SVNREVISION from filesystem ${BUILDJAILSRC_FS}"; exit 1;}

SRC_SVNBRANCH=$(rdnzl_zfs_get_property_value "${BUILDJAILSRC_FS}" "${SVNBRANCHPROP}") || \
    { echo "Can not read SVNBRANCH from filesystem ${BUILDJAILSRC_FS}"; exit 1;}

OBJ_SVNREVISION=$(rdnzl_zfs_get_property_value "${BUILDJAILOBJ_FS}" "${SVNREVISIONPROP}") || \
    { echo "Can not read SVNREVISION from filesystem ${BUILDJAILOBJ_FS}"; exit 1;}

OBJ_SVNBRANCH=$(rdnzl_zfs_get_property_value "${BUILDJAILOBJ_FS}" "${SVNBRANCHPROP}") || \
    { echo "Can not read SVNBRANCH from filesystem ${BUILDJAILOBJ_FS}"; exit 1;}

# All the branches should be the same if everything was done correctly by the
# previous scripts. This error should never happen though...
if test "${SRC_SVNBRANCH}" !=  "${OBJ_SVNBRANCH}"; then
    echo "Branch of sources ${SRC_SVNBRANCH} does not match the branch of the objects ${OBJ_SVNBRANCH}."
    echo "Check your setup."
    exit 1
fi


# Only the SVNREVISIONS should differ. If the sources have higher SVNREVISION
# than the objects we will launch 'make buildworld buildkernel' in the
# buildjail.
# TODO: What if the user really wants to go backwards in revisions or rebuild
# using the same revision? Require -f flag probably...

if test "${SRC_SVNREVISION}" -gt "${OBJ_SVNREVISION}"; then
    echo "Sources at buildjail ${BUILDJAIL} are newer than the objects."
    echo "Launching 'make buildworld buildkernel'"

    # TODO: Configure -j # automatically.
    # TODO: Set up automatic logging of builds and installs.
    # TODO: Handle errors from the build.
    rdnzl_in_jail "${BUILDJAIL}" /usr/bin/make -C /usr/src -j 4 \
        buildworld buildkernel || \
    { echo "'make buildworld buildkernel' failed."; exit 1;}

    # Record the new SVNREVISION (of the sources used) to the buildjail /usr/obj filesystem
    "${ZFS_CMS}" set "${SVNREVISIONPROP}=${SRC_SVNREVISION}" \
        "${BUILDJAILOBJ_FS}"
fi
